<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>管理员审核</title>
  <style>
    body { max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
    .auth { margin-bottom: 2rem; padding: 1rem; border: 1px solid #eee; }
    .apply-list { margin-top: 2rem; }
    .apply-item { padding: 1rem; border: 1px solid #eee; margin: 1rem 0; }
    button { padding: 0.5rem 1rem; margin-right: 0.5rem; cursor: pointer; }
    .approve { background: green; color: white; border: none; }
    .reject { background: red; color: white; border: none; }
    #applyContainer { display: none; }
  </style>
</head>
<body>
  <h1>成员申请审核</h1>
  <!-- 管理员鉴权 -->
  <div class="auth">
    <label>管理员密码</label>
    <input type="password" id="adminPwd" placeholder="请输入管理员密码">
    <button onclick="checkAdmin()">登录</button>
    <div id="authResult"></div>
  </div>

  <!-- 申请列表（登录后显示） -->
  <div id="applyContainer" class="apply-list">
    <h2>待审核申请</h2>
    <div id="applyList"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
  <script>
    // 配置
    const supabaseUrl = "https://qcxrfubkltphtvdfiikp.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjeHJmdWJrbHRwaHR2ZGZpaWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NzkxOTMsImV4cCI6MjA4MjE1NTE5M30.v6Pd4R9wDdl5Ms8JfFu6wDneuO2_pj5LB8frEN1d6q8";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);
    const ADMIN_PWD = "你的管理员密码";
    function checkAdmin() {
      const pwd = document.getElementById('adminPwd').value;
      const authResult = document.getElementById('authResult');
      if (pwd === ADMIN_PWD) {
        authResult.innerHTML = '<span style="color:green">登录成功！</span>';
        document.getElementById('applyContainer').style.display = 'block';
        loadApplyList(); // 加载待审核申请
      } else {
        authResult.innerHTML = '<span style="color:red">密码错误！</span>';
      }
    }

    // 加载待审核申请
    async function loadApplyList() {
      const applyListEl = document.getElementById('applyList');
      // 查询待审核（status=pending）的申请
      const { data, error } = await supabase
        .from('apply_requests')
        .select('*')
        .eq('status', 'pending')
        .order('create_time', { ascending: false });

      if (error) {
        applyListEl.innerHTML = `<span style="color:red">加载失败：${error.message}</span>`;
        return;
      }

      if (data.length === 0) {
        applyListEl.innerHTML = '暂无待审核申请';
        return;
      }

      // 渲染申请列表
      applyListEl.innerHTML = data.map(item => `
        <div class="apply-item">
          <div>申请ID：${item.id}</div>
          <div>姓名：${item.name}</div>
          <div>Token哈希：${item.token_hash}</div>
          <div>申请理由：${item.reason || '无'}</div>
          <div>提交时间：${new Date(item.create_time).toLocaleString()}</div>
          <div style="margin-top: 1rem;">
            <input type="text" id="note-${item.id}" placeholder="审核备注（选填）">
            <button class="approve" onclick="approveApply(${item.id})">批准</button>
            <button class="reject" onclick="rejectApply(${item.id})">驳回</button>
          </div>
        </div>
      `).join('');
    }

    // 批准申请（同步到正式表+更新状态）
    async function approveApply(id) {
      const note = document.getElementById(`note-${id}`).value.trim() || '批准加入';
      try {
        // 1. 获取申请详情
        const { data: applyData, error: getError } = await supabase
          .from('apply_requests')
          .select('name, token_hash')
          .eq('id', id)
          .single();
        if (getError) throw getError;

        // 2. 同步到正式成员表
        const { error: insertError } = await supabase
          .from('official_members')
          .insert([{ name: applyData.name, token_hash: applyData.token_hash }]);
        if (insertError) throw insertError;

        // 3. 更新审核状态
        const { error: updateError } = await supabase
          .from('apply_requests')
          .update({ 
            status: 'approved', 
            review_note: note, 
            review_time: new Date() 
          })
          .eq('id', id);
        if (updateError) throw updateError;

        alert('批准成功！');
        loadApplyList(); // 刷新列表
      } catch (err) {
        alert(`批准失败：${err.message}`);
      }
    }

    // 驳回申请（仅更新状态）
    async function rejectApply(id) {
      const note = document.getElementById(`note-${id}`).value.trim() || '驳回申请';
      try {
        const { error } = await supabase
          .from('apply_requests')
          .update({ 
            status: 'rejected', 
            review_note: note, 
            review_time: new Date() 
          })
          .eq('id', id);
        if (error) throw error;

        alert('驳回成功！');
        loadApplyList(); // 刷新列表
      } catch (err) {
        alert(`驳回失败：${err.message}`);
      }
    }
  </script>
</body>
</html>
