<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>QMet Group 管理员后台</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 0 1rem;
      font-family: "Microsoft YaHei", Arial, sans-serif;
      background-color: #f8f9fa;
    }
    .container {
      background: #ffffff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    h1 { color: #212529; margin-bottom: 2rem; text-align: center; font-size: 24px; }

    .apply-table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; }
    .apply-table th, .apply-table td { padding: 1rem; text-align: left; border-bottom: 1px solid #e9ecef; }
    .apply-table th { background-color: #f8f9fa; font-weight: 600; color: #212529; }
    .apply-table tr:hover { background-color: #f8f9fa; }

    .status-tag { padding: 0.3rem 0.8rem; border-radius: 4px; color: white; font-size: 12px; font-weight: 500; }
    .status-wait { background-color: #ffc107; }
    .status-approve { background-color: #28a745; }
    .status-reject { background-color: #dc3545; }

    .action-btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500; margin-right: 0.5rem; }
    .approve-btn { background-color: #28a745; color: white; }
    .reject-btn { background-color: #dc3545; color: white; }

    .refresh-btn { background-color: #0078d4; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-bottom: 1rem; }
    .refresh-btn:hover { background-color: #005a9e; }

    .empty-tip, .loading-tip, .error-tip { text-align: center; padding: 2rem; font-size: 16px; color: #6c757d; }
    .error-tip { color: #dc3545; }
    .loading-tip { color: #0078d4; }

    /* 登录遮罩 */
    .login-mask {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.35);
      display: flex; align-items: center; justify-content: center;
      z-index: 999;
    }
    .login-card {
      background: #fff; padding: 1.8rem; border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      width: 320px;
    }
    .login-card h2 { margin-bottom: 1rem; font-size: 18px; text-align: center; }
    .login-card label { display: block; margin-bottom: 0.5rem; color: #333; }
    .login-card input {
      width: 100%; padding: 0.6rem 0.8rem;
      border: 1px solid #ced4da; border-radius: 6px;
      margin-bottom: 0.8rem; font-size: 14px;
    }
    .login-card button {
      width: 100%; padding: 0.7rem;
      background: #0078d4; color: #fff; border: none;
      border-radius: 6px; cursor: pointer; font-size: 14px;
    }
    .login-card button:hover { background: #005a9e; }
    .login-error { color: #dc3545; font-size: 13px; min-height: 18px; margin-bottom: 0.5rem; text-align: center; }
  </style>
</head>
<body>
  <!-- 登录遮罩 -->
  <div class="login-mask" id="loginMask">
    <div class="login-card">
      <h2>管理员登录</h2>
      <label for="adminPassword">请输入管理员密码</label>
      <input type="password" id="adminPassword" placeholder="管理员密码">
      <div class="login-error" id="loginError"></div>
      <button id="loginBtn">登录</button>
    </div>
  </div>

  <div class="container" id="appContainer" style="display:none;">
    <h1>认证申请管理后台</h1>
    <button class="refresh-btn" id="refreshListBtn">刷新申请列表</button>
    <div id="applyListContainer" class="loading-tip">正在加载申请列表...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = "https://qcxrfubkltphtvdfiikp.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjeHJmdWJrbHRwaHR2ZGZpaWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NzkxOTMsImV4cCI6MjA4MjE1NTE5M30.v6Pd4R9wDdl5Ms8JfFu6wDneuO2_pj5LB8frEN1d6q8";

    // 仅保存哈希，不暴露明文密码。此值为 SHA-256("5ifsEZKn") 的 16 进制。
    const ADMIN_PASSWORD_HASH = "9c1e5f2a907cdf10d617e976612b180da0db022644f55e5f4a2b90e1091cf07a";

    let supabase;

    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (e) {
      document.getElementById('applyListContainer').innerHTML = '<div class="error-tip">❌ 系统初始化失败：' + e.message + '</div>';
      console.error("Supabase初始化失败:", e);
    }

    const loginMask = document.getElementById('loginMask');
    const appContainer = document.getElementById('appContainer');
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    const passwordInput = document.getElementById('adminPassword');
    const AUTH_FLAG = "QMET_ADMIN_AUTH_OK";

    function toHex(buffer) {
      return Array.from(new Uint8Array(buffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function hashPassword(pwd) {
      const enc = new TextEncoder().encode(pwd);
      const digest = await crypto.subtle.digest('SHA-256', enc);
      return toHex(digest);
    }

    function setAuthed() {
      sessionStorage.setItem(AUTH_FLAG, "1");
      loginMask.style.display = "none";
      appContainer.style.display = "block";
    }

    function isAuthed() {
      return sessionStorage.getItem(AUTH_FLAG) === "1";
    }

    async function handleLogin() {
      const pwd = passwordInput.value || "";
      loginError.textContent = "";
      try {
        const hashed = await hashPassword(pwd);
        if (hashed === ADMIN_PASSWORD_HASH) {
          setAuthed();
          loadApplyList();
        } else {
          loginError.textContent = "密码错误，请重试";
        }
      } catch (err) {
        console.error("登录校验失败:", err);
        loginError.textContent = "校验失败，请重试";
      }
    }

    passwordInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') handleLogin();
    });
    loginBtn.addEventListener('click', handleLogin);

    // 格式化时间
    function formatTime(isoTime) {
      if (!isoTime) return '未知时间';
      return new Date(isoTime).toLocaleString('zh-CN', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      });
    }

    async function loadApplyList() {
      const container = document.getElementById('applyListContainer');
      container.innerHTML = '<div class="loading-tip">正在加载申请列表...</div>';

      if (!supabase) {
        container.innerHTML = '<div class="error-tip">❌ 数据库连接失败，请刷新页面</div>';
        return;
      }
      if (!isAuthed()) {
        container.innerHTML = '<div class="error-tip">❌ 请先完成管理员登录</div>';
        return;
      }

      try {
        const { data, error } = await supabase
          .from('audit_records')
          .select('*')
          .order('apply_time', { ascending: false });

        if (error) throw new Error(error.message);

        if (!data || data.length === 0) {
          container.innerHTML = '<div class="empty-tip">暂无认证申请记录</div>';
          return;
        }

        let tableHtml = `
          <table class="apply-table">
            <thead>
              <tr>
                <th>8位审核编号</th>
                <th>用户名</th>
                <th>提交时间</th>
                <th>当前状态</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
        `;

        data.forEach(item => {
          let statusClass = 'status-wait';
          let statusText = '待审核';
          if (item.status === '通过') { statusClass = 'status-approve'; statusText = '审核通过'; }
          else if (item.status === '拒绝') { statusClass = 'status-reject'; statusText = '审核拒绝'; }

          let actionBtns = '';
          if (item.status === '待审核') {
            actionBtns = `
              <button class="action-btn approve-btn" onclick="updateAuditStatus('${item.check_id}', '通过')">通过</button>
              <button class="action-btn reject-btn" onclick="updateAuditStatus('${item.check_id}', '拒绝')">拒绝</button>
            `;
          } else {
            actionBtns = '<span style="color:#6c757d;font-size:12px;">已审核</span>';
          }

          tableHtml += `
            <tr>
              <td>${item.check_id || '未知'}</td>
              <td>${item.username || '未知'}</td>
              <td>${formatTime(item.apply_time)}</td>
              <td><span class="status-tag ${statusClass}">${statusText}</span></td>
              <td>${actionBtns}</td>
            </tr>
          `;
        });

        tableHtml += `</tbody></table>`;
        container.innerHTML = tableHtml;

      } catch (err) {
        container.innerHTML = `<div class="error-tip">❌ 加载申请列表失败：${err.message}</div>`;
        console.error("加载申请列表错误:", err);
      }
    }

    async function updateAuditStatus(checkId, status) {
      if (!isAuthed()) { alert("请先完成管理员登录"); return; }
      if (!confirm(`确认将编号${checkId}的申请设置为【${status}】吗？`)) return;
      if (!supabase) { alert("数据库连接失败，请刷新页面"); return; }

      try {
        const { error } = await supabase
          .from('audit_records')
          .update({ status: status })
          .eq('check_id', checkId);

        if (error) throw new Error(error.message);

        alert(`审核状态更新成功！编号${checkId} → ${status}`);
        loadApplyList();
      } catch (err) {
        alert(`更新失败：${err.message}`);
        console.error("更新审核状态错误:", err);
      }
    }

    // 绑定事件
    document.addEventListener('DOMContentLoaded', function() {
      if (isAuthed()) {
        setAuthed();
        loadApplyList();
      }
      const refreshBtn = document.getElementById('refreshListBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', loadApplyList);
      window.updateAuditStatus = updateAuditStatus;
    });
  </script>
</body>
</html>
