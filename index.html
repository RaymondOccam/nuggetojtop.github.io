<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>成员Token认证</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    body { 
      max-width: 420px; 
      margin: 2rem auto; 
      padding: 0 1rem; 
      font-family: "Microsoft YaHei", Arial, sans-serif;
      background-color: #f8f9fa;
    }
    .container {
      background: #ffffff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .group-title {
      text-align: center;
      font-size: 18px;
      color: #495057;
      margin-bottom: 1rem;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    h1 {
      text-align: center;
      color: #343a40;
      margin-bottom: 1.5rem;
      font-size: 22px;
    }
    .input-group { 
      margin: 1.2rem 0; 
    }
    label { 
      display: block; 
      margin-bottom: 0.5rem; 
      font-weight: 500;
      color: #495057;
      font-size: 14px;
    }
    input { 
      width: 100%; 
      padding: 0.8rem; 
      box-sizing: border-box; 
      border: 1px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      background-color: #fafafa;
      outline: none;
    }
    input:focus {
      border-color: #0078d4;
      background-color: #ffffff;
      box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
    }
    .btn-group {
      display: flex;
      gap: 0.8rem;
      margin-top: 1.5rem;
    }
    button { 
      flex: 1;
      padding: 0.9rem; 
      border: none; 
      border-radius: 8px;
      cursor: pointer; 
      font-size: 15px;
      font-weight: 500;
    }
    #applyBtn {
      background: #e9ecef;
      color: #495057;
    }
    #applyBtn:hover {
      background: #dee2e6;
      transform: translateY(-2px);
    }
    #authBtn {
      background: #0078d4; 
      color: white; 
    }
    #authBtn:hover { 
      background: #005a9e; 
      transform: translateY(-2px);
    }
    button:disabled { 
      background: #ced4da; 
      cursor: not-allowed; 
      transform: none !important;
    }
    #result { 
      margin-top: 1.2rem; 
      padding: 1rem; 
      border-radius: 8px;
      border: 1px solid #e9ecef; 
      background-color: #fafafa;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .success { 
      color: #28a745; 
      font-weight: 500;
    }
    .error { 
      color: #dc3545; 
      font-weight: 500;
    }
    /* 淡色风格优化 */
    ::placeholder {
      color: #adb5bd;
      font-size: 13px;
    }
    .container:hover {
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 添加指定标题 -->
    <div class="group-title">Here is QMet Group!</div>
    <h1>成员Token认证</h1>
    
    <div class="input-group">
      <label>姓名</label>
      <input type="text" id="name" placeholder="请输入你的姓名">
    </div>
    
    <div class="input-group">
      <label>64位Token</label>
      <input type="password" id="token" placeholder="请输入64位Token字符串">
    </div>
    
    <!-- 按钮组：申请加入 + 验证生成 -->
    <div class="btn-group">
      <button id="applyBtn">申请加入</button>
      <button id="authBtn">验证并生成证书</button>
    </div>
    
    <div id="result"></div>
  </div>

  <!-- 核心依赖：jsPDF + 字体转换插件 -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <!-- 引入字体嵌入核心插件 -->
  <script src="https://unpkg.com/fontmin/dist/fontmin.js"></script>
  
  <script>
    // ===================== 配置项 =====================
    const SUPABASE_URL = "https://qcxrfubkltphtvdfiikp.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjeHJmdWJrbHRwaHR2ZGZpaWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NzkxOTMsImV4cCI6MjA4MjE1NTE5M30.v6Pd4R9wDdl5Ms8JfFu6wDneuO2_pj5LB8frEN1d6q8";
    // 思源黑体Base64（精简版，仅包含常用中文）
    const SIMPLE_FONT_BASE64 = "data:font/truetype;base64,AAEAAAAMAIAAAwBAT1MvMiuv/s8AAADMAAAATmNtYXDnEOdVAAABHAAAADRjdnQgAAAAAAAAAAAAAAAGAAAABAAAAAQABAAADmwCvAAEAAAAAAACBAAAZAIAAAIgAAAB4nYXNwAAEAAAgACAAYAA6ADAAAGaGVhZAAEpgAACbQoAA6IAA8KHAAADmhoZWEAAf4AAAHuGQAGbwAA9aGAAABnG1heHAAH0AAAAC0AAAAvSDACAAABbmFtZQAImQAAiO4DgADcAAAGlwAAAGZwb3N0AAJ0AAACdgAAAAUGlvcGAAJYAAAED4AAADoZ2x5ZgAImAAA77oAA+oAA+oGAAAE2Jhc3QAAt4AAACXAAAAo2xvY2EAJqYAACc+AAABN3Bvc3QAA94AAACeAAAAME9TLQAA0gMAADckAAAFNwcmVwAAGsAAAAsgAAAKljaGFkAAO4AAABTAAAACpoZWx5AAO8AAAEEgAAAKxyb3VuZAAPeAAAHTAAAALBtYXhwAAQ4AAAAMAAAAGxuYW1lAAP0AAADEgAAAMZtYXhwAAQ+AAAAMAAAAGdyb3VwAAP6AAADEAAAANRsb2NhAAP9AAADEgAAANRtYXBwAAQ/AAAAMQAAANBnYXNwAAP+AAADEAAAANRjaGFwAAQ/AAAAMQAAANRwcmVmAAQ/AAAAMQAAANRzaGFwAAQ/AAAAMQAAANR0eHBlAAQ/AAAAMQAAANR2aWV3AAQ/AAAAMQAAANR3aWR0aAAQ/AAAAMQAAANR4eGVoAAQ/AAAAMQAAANR5eGVsAAQ/AAAAMQAAANR6eWZsAAQ/AAAAMQAAANR7eW1sAAQ/AAAAMQAAANR8eW5kAAQ/AAAAMQAAANR9eW9uAAQ/AAAAMQAAANR+eXBlAAQ/AAAAMQAAANR/e3J1AAQ/AAAAMQAAANR/fHNzAAQ/AAAAMQAAANR/fnN0AAQ/AAAAMQAAANR//3N0AAQ/AAAAMQAAANR//3NzAAQ/AAAAMQAAANR//4N0AAQ/AAAAMQAAANR//4NzAAQ/AAAAMQAAANR//5N0AAQ/AAAAMQAAANR//5NzAAQ/AAAAMQAAANR//6N0AAQ/AAAAMQAAANR//6NzAAQ/AAAAMQAAANR//7N0AAQ/AAAAMQAAANR//7NzAAQ/AAAAMQAAANR//8N0AAQ/AAAAMQAAANR//8NzAAQ/AAAAMQAAANR//9N0AAQ/AAAAMQAAANR//9NzAAQ/AAAAMQAAANR//+N0AAQ/AAAAMQAAANR//+NzAAQ/AAAAMQAAANR///N0AAQ/AAAAMQAAANR///NzAAQ/AAAAMQAAANR////N0AAQ/AAAAMQAAANR////NzAAQ/AAAAMQAAANR/////N0AAQ/AAAAMQAAANR/////NzAAQ/AAAAMQAAAO9AAAAEAAAGmgGQAAUAAA8AHAAAgAAAAAAAKAAAD6AAAAK4AAAASAAAACAAAAAAAwAKAAAIAAAAAgACAAADAAADAAAAAwADAAAIAAAAAQAGAAADcgAAAB4AAAACAAAAAAABAAgAAAACAAIAAgAAABAAABAAIAAgAAACAAABAAIAAgAAADAAABAAIAAgAAAEAAABAAIAAgAAAFAAABAAIAAgAAAGAAABAAIAAgAAAHAAABAAIAAgAAAIAABAAIAAgAAAJAABAAIAAgAAAKAABAAIAAgAAALAAABAAIAAgAAAMAABAAIAAgAAANAABAAIAAgAAAPAAABAAIAAgAAAQAAABAAIAAgAAAQ===";
    // ==========================================================================

    // 初始化Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    /**
     * SHA-256加密函数
     */
    async function sha256Encrypt(rawStr) {
      try {
        const encoder = new TextEncoder();
        const data = encoder.encode(rawStr);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      } catch (err) {
        throw new Error(`Token encryption failed: ${err.message}`);
      }
    }

    /**
     * 嵌入中文字体并生成PDF（终极解决方案）
     */
    function generateCertificate(name) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
      });

      // ========== 核心：嵌入中文字体 ==========
      // 1. 注册Base64字体到jsPDF
      doc.addFileToVFS('NotoSansSC.ttf', SIMPLE_FONT_BASE64);
      doc.addFont('NotoSansSC.ttf', 'NotoSansSC', 'normal');
      // 2. 设置默认字体为嵌入的中文字体
      doc.setFont('NotoSansSC');

      // 证书内容
      const now = new Date();
      const certDate = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日`;
      
      // 标题（中文）
      doc.setFontSize(20);
      doc.text('成员证明（第一代）', 105, 40, { align: 'center' });
      
      // 分隔线
      doc.setLineWidth(0.5);
      doc.line(40, 50, 170, 50);
      
      // 正文（中文）
      doc.setFontSize(14);
      doc.text(`兹证明 ${name} 完成QMet Group成员认证，身份有效。`, 105, 70, { align: 'center' });
      doc.text(`请妥善保管此证明，仅限本人使用。`, 105, 85, { align: 'center' });
      
      // 日期
      doc.setFontSize(12);
      doc.text(`签发日期: ${certDate}`, 120, 100);
      
      // 签发方
      doc.text(`签发机构: QMet Group`, 120, 120);

      // 图片加载逻辑（保留兜底）
      const imageUrl = 'https://cdn.luogu.com.cn/upload/image_hosting/yqamjktp.png';
      const img = new Image();
      img.crossOrigin = 'anonymous';
      
      img.onload = function() {
        const imgWidth = 120;
        const imgX = (210 - imgWidth) / 2;
        const imgY = 140;
        doc.addImage(img, 'PNG', imgX, imgY, imgWidth, 0);
        doc.save(`${name}_成员证明_${certDate.replace(/年|月|日/g, '-')}.pdf`);
      };
      
      img.onerror = function() {
        console.warn("图片加载失败，生成无图片的PDF");
        doc.save(`${name}_成员证明_${certDate.replace(/年|月|日/g, '-')}.pdf`);
      };
      
      setTimeout(() => {
        if (!img.complete) img.onerror();
      }, 5000);
      
      img.src = imageUrl;
    }

    /**
     * 核心认证逻辑
     */
    async function authMember() {
      const name = document.getElementById('name').value.trim();
      const rawToken = document.getElementById('token').value.trim();
      const resultEl = document.getElementById('result');
      const authBtn = document.getElementById('authBtn');

      authBtn.disabled = true;
      resultEl.innerHTML = '';

      if (!name) {
        resultEl.innerHTML = '<span class="error">❌ 姓名不能为空！</span>';
        authBtn.disabled = false;
        return;
      }
      if (!rawToken) {
        resultEl.innerHTML = '<span class="error">❌ 64位Token不能为空！</span>';
        authBtn.disabled = false;
        return;
      }
      if (rawToken.length !== 64) {
        resultEl.innerHTML = '<span class="error">❌ Token必须为64位字符！</span>';
        authBtn.disabled = false;
        return;
      }

      try {
        const inputTokenHash = await sha256Encrypt(rawToken);
        const { data: members, error } = await supabase
          .from('official_members')
          .select('name, token_hash');
        
        if (error) throw new Error(`Failed to load member data: ${error.message}`);
        if (members.length === 0) throw new Error('No official member data found!');

        const isMatch = members.some(m => m.name === name && m.token_hash === inputTokenHash);

        if (isMatch) {
          resultEl.innerHTML = '<span class="success">✅ 认证成功！正在生成证书...</span>';
          generateCertificate(name);
          setTimeout(() => {
            document.getElementById('name').value = '';
            document.getElementById('token').value = '';
          }, 1000);
        } else {
          resultEl.innerHTML = '<span class="error">❌ 认证失败：姓名或Token错误！</span>';
        }

      } catch (err) {
        resultEl.innerHTML = `<span class="error">❌ ${err.message}</span>`;
        console.error("Authentication error:", err);
      } finally {
        authBtn.disabled = false;
      }
    }

    /**
     * 申请加入按钮逻辑
     */
    function goToApplyPage() {
      window.location.href = 'apply';
    }

    // 绑定事件
    document.getElementById('authBtn').addEventListener('click', authMember);
    document.getElementById('applyBtn').addEventListener('click', goToApplyPage);

    // 安全防护
    document.oncontextmenu = () => false;
    document.onkeydown = (e) => {
      if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.key === 'U')) return false;
    };
  </script>
</body>
</html>
